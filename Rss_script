local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")

local Player = Players.LocalPlayer
local _G = _G or {} 

-- Настройки
_G.AutoFarm = true
_G.AutoQuest = true
_G.FruitESP = true -- Включить/Выключить ESP
_G.AttackDist = 60 -- Расстояние над мобом

-- // ФУНКЦИЯ СОЗДАНИЯ ESP //
local function CreateESP(part, name)
    if part:FindFirstChild("FruitESP") then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "FruitESP"
    billboard.Adornee = part
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 2, 0)
    billboard.AlwaysOnTop = true
    
    local label = Instance.new("TextLabel")
    label.Parent = billboard
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 0, 0) -- Красный цвет
    label.TextStrokeTransparency = 0
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 14
    label.Text = name
    
    billboard.Parent = part
end

-- // ФУНКЦИЯ ПОЛУЧЕНИЯ ТЕКУЩЕГО КВЕСТА //
local function GetQuestTarget()
    local gui = Player:FindFirstChild("PlayerGui")
    if gui and gui:FindFirstChild("Main") and gui.Main:FindFirstChild("Quest") then
        local q = gui.Main.Quest
        if q.Visible then
            local t = q.Container.QuestTitle.Title.Text:lower()
            if string.find(t, "bandit") then return "Bandit" end
            if string.find(t, "monkey") then return "Monkey" end
            if string.find(t, "gorilla") then return "Gorilla" end
            if string.find(t, "pirate") then return "Pirate" end
        end
    end
    return nil
end

-- // ФУНКЦИЯ ЭКИПИРОВКИ ЛУЧШЕГО ОРУЖИЯ //
local function EquipBest()
    local char = Player.Character
    if not char then return end
    
    -- Если оружие уже в руках, ничего не делаем
    local currentTool = char:FindFirstChildOfClass("Tool")
    if currentTool then return currentTool end

    for _, t in pairs(Player.Backpack:GetChildren()) do
        if t:IsA("Tool") and (t.ToolTip == "Melee" or t.Name == "Combat" or t.ToolTip == "Sword") then
            char.Humanoid:EquipTool(t)
            return t
        end
    end
end

-- // ПОИСК БЛИЖАЙШЕГО ВРАГА //
local function GetClosestEnemy(targetName)
    local closest = nil
    local minDist = math.huge
    local myRoot = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
    
    if not myRoot then return nil end
    local enemies = Workspace:FindFirstChild("Enemies")
    if not enemies then return nil end

    for _, v in pairs(enemies:GetChildren()) do
        if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v:FindFirstChild("HumanoidRootPart") then
            if not targetName or string.find(v.Name, targetName) then
                local dist = (v.HumanoidRootPart.Position - myRoot.Position).Magnitude
                if dist < minDist then
                    minDist = dist
                    closest = v
                end
            end
        end
    end
    return closest
end

-- // ОСНОВНОЙ ЦИКЛ //
task.spawn(function()
    while task.wait() do -- Можно поставить task.wait(0.1) для снижения нагрузки
        if _G.AutoFarm and Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
            pcall(function()
                -- 1. Берем квест
                if _G.AutoQuest then
                    local gui = Player:FindFirstChild("PlayerGui")
                    if gui and gui:FindFirstChild("Main") and not gui.Main.Quest.Visible then
                        local lvl = Player.Data.Level.Value
                        local args = nil
                        if lvl < 10 then args = {"StartQuest", "BanditQuest1", 1}
                        elseif lvl < 15 then args = {"StartQuest", "JungleQuest", 1}
                        else args = {"StartQuest", "JungleQuest", 2} end
                        
                        if args then
                            ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args))
                        end
                    end
                end

                -- 2. Ищем цель
                local targetName = GetQuestTarget()
                local target = GetClosestEnemy(targetName)

                -- 3. Бой и Движение
                if target and target:FindFirstChild("HumanoidRootPart") then
                    local weapon = EquipBest()
                    
                    -- Прямое зависание над мобом (без наклона)
                    local targetPos = target.HumanoidRootPart.CFrame * CFrame.new(0, _G.AttackDist, 0)
                    
                    Player.Character.HumanoidRootPart.CFrame = targetPos
                    Player.Character.HumanoidRootPart.Velocity = Vector3.zero
                    
                    -- Удары (Kill Aura)
                    if weapon then weapon:Activate() end
                    
                    -- Эмуляция кликов (для некоторых оружий)
                    VirtualUser:CaptureController()
                    VirtualUser:ClickButton1(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
                end
            end)
        end
    end
end)

-- // ESP ЦИКЛ (ОБНОВЛЕНИЕ ДИСТАНЦИИ) //
task.spawn(function()
    while task.wait(0.5) do -- Обновляем каждые 0.5 сек для оптимизации
        if _G.FruitESP and Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
            pcall(function()
                for _, v in pairs(Workspace:GetChildren()) do
                    if string.find(v.Name, "Fruit") and v:IsA("Tool") and v:FindFirstChild("Handle") then
                        CreateESP(v.Handle, v.Name)
                        
                        -- Обновляем текст (дистанция)
                        local dist = math.floor((Player.Character.HumanoidRootPart.Position - v.Handle.Position).Magnitude)
                        if v.Handle:FindFirstChild("FruitESP") then
                            v.Handle.FruitESP.TextLabel.Text = v.Name .. " [" .. dist .. "m]"
                        end
                    end
                end
            end)
        end
    end
end)

-- // Noclip (Оптимизированный) //
RunService.Stepped:Connect(function()
    if _G.AutoFarm and Player.Character then
        -- Отключаем коллизию только для персонажа, чтобы не застревать
        for _, v in pairs(Player.Character:GetDescendants()) do
            if v:IsA("BasePart") and v.CanCollide then
                v.CanCollide = false
            end
        end
    end
end)
