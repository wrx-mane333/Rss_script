local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "RSS | Hitbox Magnet (Fixed + Visualizer)",
    LoadingTitle = "–ó–∞–≥—Ä—É–∑–∫–∞ Hitbox Magnet...",
    LoadingSubtitle = "Improved by Replit Agent",
    ConfigurationSaving = { Enabled = false }
})

local Tab = Window:CreateTab("üß≤ Hitbox", 4483362458)
local TabGK = Window:CreateTab("ü•Ö –í—Ä–∞—Ç–∞—Ä—å", 4483362458)

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏
local Settings = {
    HitboxEnabled = false,
    VisualizerEnabled = false,  -- NEW: Visualizer setting
    HitboxRadius = 8,
    HitboxStrength = 80,
    HitboxUseBodyVelocity = true,
    PerBallCooldown = 0.35,
    GKMode = true,
    GK_SaveSpeed = 140,
    GK_MinBallSpeed = 15,
    GK_DotThreshold = 0.7,
    GK_MaxDistanceToAttempt = 18
}

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local workspace = game:GetService("Workspace")

local hitboxPart = nil
local activeBV = {}
local perBallLast = {}
local connection = nil

local function createHitbox()
    if hitboxPart then hitboxPart:Destroy() end
    hitboxPart = Instance.new("Part")
    hitboxPart.Name = "RSS_Hitbox"
    hitboxPart.Anchored = true
    hitboxPart.CanCollide = false
    -- Transparency –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Visualizer
    hitboxPart.Transparency = Settings.VisualizerEnabled and 0.5 or 1
    hitboxPart.Color = Color3.fromRGB(255, 0, 0) -- –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
    hitboxPart.Size = Vector3.new(Settings.HitboxRadius*2, Settings.HitboxRadius*2, Settings.HitboxRadius*2)
    hitboxPart.Shape = Enum.PartType.Ball
    hitboxPart.Material = Enum.Material.ForceField -- –ö—Ä–∞—Å–∏–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
    hitboxPart.Parent = workspace

    hitboxPart.Touched:Connect(function(part)
        if not part or not part:IsA("BasePart") then return end
        local name = part.Name:lower()
        if not (name:find("ball") or name:find("soccer")) then return end

        local now = tick()
        local last = perBallLast[part]
        if last and now - last < Settings.PerBallCooldown then return end
        perBallLast[part] = now

        local ok, vel = pcall(function() return part.AssemblyLinearVelocity end)
        if not ok then vel = Vector3.new(0,0,0) end

        -- GK Logic
        if Settings.GKMode then
            local function findMyGoal()
                local char = LocalPlayer.Character
                if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
                local hrp = char.HumanoidRootPart
                
                -- Optimization: Cache goals or better search
                local closest, dist = nil, math.huge
                for _, v in pairs(workspace:GetDescendants()) do
                    if v.Name == "GoalieCenter" and v:IsA("BasePart") then
                        local d = (hrp.Position - v.Position).Magnitude
                        if d < dist then dist = d; closest = v end
                    end
                end
                return closest, dist
            end

            local myGoal, distToGoal = findMyGoal()
            if myGoal then
                local dirToGoal = (myGoal.Position - part.Position)
                if dirToGoal.Magnitude > 0.001 and vel.Magnitude > 0.1 then
                    local ballDir = vel.Unit
                    local dirUnit = dirToGoal.Unit
                    local dot = dirUnit:Dot(ballDir)
                    
                    local char = LocalPlayer.Character
                    local hrp = char and char:FindFirstChild("HumanoidRootPart")
                    local distPlayerToGoal = hrp and (hrp.Position - myGoal.Position).Magnitude or math.huge

                    if vel.Magnitude >= Settings.GK_MinBallSpeed and dot >= Settings.GK_DotThreshold and distPlayerToGoal > Settings.GK_MaxDistanceToAttempt then
                        local saveDir = (part.Position - myGoal.Position).Unit
                        saveDir = Vector3.new(saveDir.X, 0.35, saveDir.Z).Unit
                        
                        pcall(function()
                            part.AssemblyLinearVelocity = saveDir * Settings.GK_SaveSpeed
                        end)
                        
                        if activeBV[part] then
                            pcall(function() activeBV[part]:Destroy() end)
                            activeBV[part] = nil
                        end
                        
                        Rayfield:Notify({Title="ü•Ö GK Save", Content="Ball deflected!", Duration=1})
                        return
                    end
                end
            end
        end

        -- Magnet Logic
        local char = LocalPlayer.Character
        if not char or not char:FindFirstChild("HumanoidRootPart") then return end
        local hrp = char.HumanoidRootPart
        local targetPos = hrp.Position + Vector3.new(0, 1.5, 0)

        local dir = (targetPos - part.Position)
        if dir.Magnitude < 0.1 then return end
        local dirUnit = dir.Unit
        
        if Settings.HitboxUseBodyVelocity then
            if not part:FindFirstChild("RSS_HitBV") then
                local bv = Instance.new("BodyVelocity")
                bv.Name = "RSS_HitBV"
                bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
                bv.Velocity = dirUnit * Settings.HitboxStrength
                bv.Parent = part
                activeBV[part] = bv
                delay(0.25, function()
                    if bv and bv.Parent then pcall(function() bv:Destroy() end) end
                    activeBV[part] = nil
                end)
            else
                local bv = part:FindFirstChild("RSS_HitBV")
                if bv then pcall(function() bv.Velocity = dirUnit * Settings.HitboxStrength end) end
            end
        else
            pcall(function() part.AssemblyLinearVelocity = dirUnit * Settings.HitboxStrength end)
        end
    end)
end

local function destroyHitbox()
    if hitboxPart then
        hitboxPart:Destroy()
        hitboxPart = nil
    end
end

local function startUpdater()
    if connection then connection:Disconnect() end
    connection = RunService.Heartbeat:Connect(function()
        if not Settings.HitboxEnabled then return end
        if not hitboxPart then createHitbox() end
        
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            hitboxPart.Position = char.HumanoidRootPart.Position
            hitboxPart.Size = Vector3.new(Settings.HitboxRadius*2, Settings.HitboxRadius*2, Settings.HitboxRadius*2)
            -- –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –Ω–∞ –ª–µ—Ç—É
            hitboxPart.Transparency = Settings.VisualizerEnabled and 0.5 or 1
        end
    end)
end

local function stopUpdater()
    if connection then connection:Disconnect() connection = nil end
    destroyHitbox()
end

-- UI Elements
Tab:CreateToggle({
    Name = "üß≤ –í–∫–ª—é—á–∏—Ç—å Hitbox",
    CurrentValue = false,
    Callback = function(val)
        Settings.HitboxEnabled = val
        if val then
            createHitbox()
            startUpdater()
            Rayfield:Notify({Title="Hitbox", Content="Enabled", Duration=1})
        else
            stopUpdater()
            Rayfield:Notify({Title="Hitbox", Content="Disabled", Duration=1})
        end
    end
})

-- NEW: Visualizer Toggle
Tab:CreateToggle({
    Name = "üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –•–∏—Ç–±–æ–∫—Å (Visualizer)",
    CurrentValue = false,
    Callback = function(val)
        Settings.VisualizerEnabled = val
        if hitboxPart then
            hitboxPart.Transparency = val and 0.5 or 1
        end
    end
})

Tab:CreateSlider({
    Name = "üìè –†–∞–¥–∏—É—Å —Ö–∏—Ç–±–æ–∫—Å–∞",
    Range = {3, 30},
    Increment = 1,
    CurrentValue = Settings.HitboxRadius,
    Callback = function(v)
        Settings.HitboxRadius = v
        if hitboxPart then hitboxPart.Size = Vector3.new(v*2, v*2, v*2) end
    end
})

Tab:CreateSlider({
    Name = "üí™ –°–∏–ª–∞ –ø—Ä–∏—Ç—è–∂–µ–Ω–∏—è",
    Range = {20, 200},
    Increment = 5,
    CurrentValue = Settings.HitboxStrength,
    Callback = function(v) Settings.HitboxStrength = v end
})

TabGK:CreateToggle({
    Name = "ü•Ö –†–µ–∂–∏–º –≤—Ä–∞—Ç–∞—Ä—è (GK)",
    CurrentValue = Settings.GKMode,
    Callback = function(v) Settings.GKMode = v end
})

-- Cleanup
game:BindToClose(function()
    stopUpdater()
    for _, bv in pairs(activeBV) do
        pcall(function() bv:Destroy() end)
    end
end)

Rayfield:Notify({Title="Script Loaded", Content="Enhanced by Replit Agent", Duration=3})
