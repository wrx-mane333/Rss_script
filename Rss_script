-- GOALKEEPER DEFENSE ZONE SYSTEM
-- Optimized ball detection and repulsion mechanism
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local lp = Players.LocalPlayer

-- CONFIGURATION
local Config = {
    ZoneRadius = 35,
    RepulsionForce = 250,
    ScanInterval = 1.5,
    UpdateRate = 0.04,
    StabilizePlayer = true,
    VisualizationEnabled = true
}

-- PERFORMANCE TRACKING
local Performance = {
    LastFrameTime = 0,
    BallCount = 0,
    ActiveRepulsions = 0
}

-- UI SETUP
local GUI = Instance.new("ScreenGui")
GUI.Name = "DefenseZone"
GUI.ResetOnSpawn = false
GUI.Parent = game.CoreGui

local Toggle = Instance.new("TextButton")
Toggle.Parent = GUI
Toggle.Size = UDim2.fromOffset(70, 70)
Toggle.Position = UDim2.new(0, 15, 0.5, -35)
Toggle.BackgroundColor3 = Color3.fromRGB(50, 150, 250)
Toggle.TextColor3 = Color3.new(1, 1, 1)
Toggle.Text = "ZONE"
Toggle.TextSize = 16
Toggle.Font = Enum.Font.GothamBold
Toggle.TextWrapped = true
local corner1 = Instance.new("UICorner", Toggle)
corner1.CornerRadius = UDim.new(0, 12)

local InfoPanel = Instance.new("Frame")
InfoPanel.Parent = GUI
InfoPanel.Size = UDim2.fromOffset(200, 120)
InfoPanel.Position = UDim2.new(0, 15, 0, 15)
InfoPanel.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
InfoPanel.BackgroundTransparency = 0.25
local corner2 = Instance.new("UICorner", InfoPanel)
corner2.CornerRadius = UDim.new(0, 10)

local InfoText = Instance.new("TextLabel")
InfoText.Parent = InfoPanel
InfoText.Size = UDim2.new(1, -10, 1, -10)
InfoText.Position = UDim2.new(0, 5, 0, 5)
InfoText.BackgroundTransparency = 1
InfoText.TextColor3 = Color3.new(1, 1, 1)
InfoText.TextSize = 13
InfoText.Font = Enum.Font.GothamMedium
InfoText.TextXAlignment = Enum.TextXAlignment.Left
InfoText.TextYAlignment = Enum.TextYAlignment.Top
InfoText.TextWrapped = true

local SystemActive = true
Toggle.MouseButton1Click:Connect(function()
    SystemActive = not SystemActive
    Toggle.BackgroundColor3 = SystemActive and Color3.fromRGB(50, 150, 250) or Color3.fromRGB(150, 50, 50)
    Toggle.Text = SystemActive and "ZONE" or "OFF"
end)

-- DEFENSE ZONE VISUALIZATION
local DefenseZone = Instance.new("Part")
DefenseZone.Name = "DefenseZone"
DefenseZone.Shape = Enum.PartType.Ball
DefenseZone.Size = Vector3.new(Config.ZoneRadius * 2, Config.ZoneRadius * 2, Config.ZoneRadius * 2)
DefenseZone.Material = Enum.Material.ForceField
DefenseZone.Color = Color3.fromRGB(50, 150, 250)
DefenseZone.Transparency = 0.8
DefenseZone.CanCollide = false
DefenseZone.Anchored = true
DefenseZone.Parent = Workspace

-- BALL REGISTRY
local BallRegistry = {}
local RepulsionCooldowns = {}

-- OPTIMIZED BALL SCANNER
local function ScanAllBalls()
    local startTime = tick()
    local foundBalls = {}
    local scannedObjects = 0
    
    -- Scan locations with priority order
    local scanTargets = {
        Workspace,
        Workspace:FindFirstChild("Balls"),
        Workspace:FindFirstChild("GameObjects"),
        Workspace:FindFirstChild("Game"),
        Workspace:FindFirstChild("Live")
    }
    
    for _, container in ipairs(scanTargets) do
        if container then
            for _, descendant in ipairs(container:GetDescendants()) do
                scannedObjects = scannedObjects + 1
                
                if descendant:IsA("BasePart") then
                    local name = string.lower(descendant.Name)
                    
                    -- Ball detection patterns
                    if string.match(name, "ball") or 
                       string.match(name, "soccer") or 
                       string.match(name, "football") or
                       string.match(name, "puck") then
                        
                        -- Validate ball is active
                        if descendant.Parent and descendant.Anchored == false then
                            table.insert(foundBalls, descendant)
                        end
                    end
                end
            end
        end
    end
    
    local scanDuration = tick() - startTime
    Performance.LastFrameTime = scanDuration
    Performance.BallCount = #foundBalls
    
    return foundBalls
end

-- PLAYER STABILIZATION SYSTEM
local function StabilizePlayer(root, humanoid)
    if not Config.StabilizePlayer then return end
    
    -- Prevent ragdoll
    if humanoid.PlatformStand then
        humanoid.PlatformStand = false
    end
    
    -- Velocity clamping
    local velocity = root.AssemblyLinearVelocity
    local maxVelocity = 70
    
    if velocity.Magnitude > maxVelocity then
        root.AssemblyLinearVelocity = velocity.Unit * maxVelocity
    end
    
    -- Vertical velocity limit
    if math.abs(velocity.Y) > 50 then
        root.AssemblyLinearVelocity = Vector3.new(
            velocity.X,
            math.clamp(velocity.Y, -50, 50),
            velocity.Z
        )
    end
    
    -- Angular velocity dampening
    if root.AssemblyAngularVelocity.Magnitude > 5 then
        root.AssemblyAngularVelocity = root.AssemblyAngularVelocity * 0.5
    end
end

-- BALL REPULSION SYSTEM
local function RepulseBall(ball, zoneCenter)
    local now = tick()
    
    -- Cooldown check
    if RepulsionCooldowns[ball] then
        if now - RepulsionCooldowns[ball] < 0.3 then
            return false
        end
    end
    
    RepulsionCooldowns[ball] = now
    Performance.ActiveRepulsions = Performance.ActiveRepulsions + 1
    
    -- Calculate repulsion vector
    local ballPosition = ball.Position
    local directionAway = (ballPosition - zoneCenter).Unit
    
    -- Add upward component for clearance
    local repulsionVector = (directionAway + Vector3.new(0, 0.35, 0)).Unit
    
    -- Consider ball's current speed
    local currentSpeed = ball.AssemblyLinearVelocity.Magnitude
    local forceMultiplier = math.clamp(1 + (currentSpeed / 150), 1, 1.8)
    
    -- Apply repulsion force
    local finalForce = repulsionVector * Config.RepulsionForce * forceMultiplier
    ball.AssemblyLinearVelocity = finalForce
    
    -- Add spin
    ball.AssemblyAngularVelocity = Vector3.new(
        math.random(-60, 60),
        math.random(-60, 60),
        math.random(-60, 60)
    )
    
    -- Visual feedback
    if Config.VisualizationEnabled then
        DefenseZone.Color = Color3.fromRGB(255, 100, 100)
        DefenseZone.Size = Vector3.new(
            Config.ZoneRadius * 2.15,
            Config.ZoneRadius * 2.15,
            Config.ZoneRadius * 2.15
        )
        
        task.delay(0.1, function()
            if DefenseZone then
                DefenseZone.Color = Color3.fromRGB(50, 150, 250)
                DefenseZone.Size = Vector3.new(
                    Config.ZoneRadius * 2,
                    Config.ZoneRadius * 2,
                    Config.ZoneRadius * 2
                )
            end
        end)
    end
    
    return true
end

-- BALL APPROACH CHECK
local function IsBallThreatening(ball, zoneCenter)
    local velocity = ball.AssemblyLinearVelocity
    
    -- Minimum speed threshold
    if velocity.Magnitude < 8 then
        return false
    end
    
    -- Direction check
    local toZone = (zoneCenter - ball.Position).Unit
    local velocityDirection = velocity.Unit
    local approachAngle = velocityDirection:Dot(toZone)
    
    -- Ball is moving toward zone
    return approachAngle > 0.2
end

-- UPDATE UI INFO
local function UpdateInfoPanel()
    local text = string.format(
        "STATUS: %s\nBALLS: %d\nREPULSIONS: %d\nSCAN TIME: %.3fs\nRADIUS: %d studs",
        SystemActive and "ACTIVE" or "DISABLED",
        Performance.BallCount,
        Performance.ActiveRepulsions,
        Performance.LastFrameTime,
        Config.ZoneRadius
    )
    InfoText.Text = text
end

-- PERIODIC BALL SCANNER
task.spawn(function()
    while true do
        BallRegistry = ScanAllBalls()
        task.wait(Config.ScanInterval)
    end
end)

-- RESET REPULSION COUNTER
task.spawn(function()
    while true do
        task.wait(1)
        Performance.ActiveRepulsions = 0
    end
end)

-- MAIN LOOP
local lastUpdate = 0
RunService.Heartbeat:Connect(function()
    local character = lp.Character
    local root = character and character:FindFirstChild("HumanoidRootPart")
    local humanoid = character and character:FindFirstChild("Humanoid")
    
    if not root or not humanoid then return end
    
    -- Player stabilization
    StabilizePlayer(root, humanoid)
    
    -- Update zone position
    DefenseZone.CFrame = root.CFrame
    DefenseZone.Transparency = SystemActive and 0.8 or 1
    
    -- Update UI
    UpdateInfoPanel()
    
    if not SystemActive then return end
    
    -- Rate limiting
    local now = tick()
    if now - lastUpdate < Config.UpdateRate then return end
    lastUpdate = now
    
    local zoneCenter = root.Position
    
    -- Process all registered balls
    for _, ball in ipairs(BallRegistry) do
        if ball and ball.Parent then
            local distance = (ball.Position - zoneCenter).Magnitude
            
            -- Ball within zone radius
            if distance < Config.ZoneRadius then
                -- Check if ball is threatening
                if IsBallThreatening(ball, zoneCenter) then
                    RepulseBall(ball, zoneCenter)
                end
                
                -- Emergency close-range repulsion
                if distance < 10 then
                    RepulseBall(ball, zoneCenter)
                end
            end
        end
    end
end)

-- CLEANUP
Players.PlayerRemoving:Connect(function(player)
    if player == lp then
        DefenseZone:Destroy()
        GUI:Destroy()
    end
end)

-- INITIALIZATION
task.spawn(function()
    task.wait(0.5)
    BallRegistry = ScanAllBalls()
    print("========================================")
    print("GOALKEEPER DEFENSE ZONE INITIALIZED")
    print("Zone Radius:", Config.ZoneRadius, "studs")
    print("Repulsion Force:", Config.RepulsionForce)
    print("Scan Interval:", Config.ScanInterval, "seconds")
    print("Balls Detected:", #BallRegistry)
    print("========================================")
end)
